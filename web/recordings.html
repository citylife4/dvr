<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DVR â€” Recordings</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #111;
    color: #ccc;
    font-family: system-ui, -apple-system, sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  nav {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 8px 16px;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
    flex-shrink: 0;
  }
  nav h1 { font-size: 16px; font-weight: 600; color: #eee; }
  nav a {
    color: #888;
    text-decoration: none;
    font-size: 14px;
    padding: 4px 12px;
    border-radius: 4px;
    transition: all 0.2s;
  }
  nav a:hover { color: #ccc; background: #2a2a2a; }
  nav a.active { color: #fff; background: #2a6a2a; }
  nav .spacer { flex: 1; }

  /* â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .ctrl-bar {
    display: flex;
    gap: 12px;
    padding: 12px 16px;
    background: #161616;
    border-bottom: 1px solid #282828;
    align-items: center;
    flex-wrap: wrap;
  }
  .ctrl-bar .label { font-size: 13px; color: #888; }
  .ctrl-btn {
    border: 1px solid #444;
    color: #ccc;
    padding: 5px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
  }
  .ctrl-btn.start { background: #1a3a1a; border-color: #2a6a2a; }
  .ctrl-btn.start:hover { background: #2a5a2a; color: #fff; }
  .ctrl-btn.stop { background: #3a1a1a; border-color: #6a2a2a; }
  .ctrl-btn.stop:hover { background: #5a2a2a; color: #fff; }
  .ctrl-btn:disabled { opacity: .4; cursor: not-allowed; }
  .status-badge {
    font-size: 12px;
    padding: 3px 10px;
    border-radius: 10px;
    font-weight: 600;
  }
  .status-badge.running { background: #1a3a1a; color: #2ecc40; border: 1px solid #2a6a2a; }
  .status-badge.stopped { background: #2a2a2a; color: #888; border: 1px solid #444; }
  .status-badge.disabled { background: #2a2a2a; color: #666; border: 1px solid #333; }

  /* â”€â”€ Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .content {
    flex: 1;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-width: 1000px;
    width: 100%;
    margin: 0 auto;
  }
  .section { background: #1a1a1a; border-radius: 8px; border: 1px solid #282828; }
  .section-head {
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 600;
    color: #eee;
    border-bottom: 1px solid #282828;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* â”€â”€ Channel cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .ch-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    padding: 14px;
  }
  .ch-card {
    background: #222;
    border-radius: 6px;
    border: 1px solid #333;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .ch-card .ch-name {
    font-size: 13px;
    font-weight: 600;
    color: #eee;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .ch-card .ch-name .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
  }
  .dot.rec { background: #e74c3c; animation: blink 1s infinite; }
  .dot.wait { background: #f39c12; }
  .dot.off { background: #555; }
  .dot.err { background: #e74c3c; }
  @keyframes blink { 50% { opacity: .3; } }
  .ch-card .ch-detail { font-size: 11px; color: #888; }

  /* â”€â”€ Upload status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .upload-row {
    padding: 14px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    font-size: 13px;
  }
  .upload-row .item { display: flex; gap: 6px; align-items: center; }
  .upload-row .val { color: #eee; }
  .upload-row .lbl { color: #888; }

  /* â”€â”€ Recordings table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .rec-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  .rec-table th {
    text-align: left;
    padding: 8px 12px;
    color: #888;
    font-weight: 500;
    border-bottom: 1px solid #333;
    font-size: 12px;
  }
  .rec-table td {
    padding: 6px 12px;
    border-bottom: 1px solid #222;
    color: #ccc;
  }
  .rec-table tr:hover td { background: #1e1e1e; }
  .rec-table .size { color: #888; }
  .rec-table .uploaded-tag {
    font-size: 10px;
    background: #1a3a1a;
    color: #2ecc40;
    padding: 1px 6px;
    border-radius: 3px;
    margin-left: 6px;
  }
  .rec-table .empty-msg {
    padding: 24px;
    text-align: center;
    color: #666;
    font-style: italic;
  }
  .del-btn {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 15px;
    padding: 0 4px;
    opacity: 0.6;
    transition: opacity 0.15s;
  }
  .del-btn:hover { opacity: 1; }

  /* â”€â”€ Config form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cfg-form {
    padding: 14px 16px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px 24px;
    font-size: 13px;
  }
  @media (max-width: 620px) { .cfg-form { grid-template-columns: 1fr; } }
  .cfg-form .full { grid-column: 1 / -1; }
  .cfg-form .field { display: flex; flex-direction: column; gap: 4px; }
  .cfg-form label { color: #888; font-size: 12px; }
  .cfg-form input[type="text"],
  .cfg-form input[type="number"],
  .cfg-form select {
    background: #111;
    border: 1px solid #444;
    color: #eee;
    padding: 5px 9px;
    border-radius: 4px;
    font-size: 13px;
    width: 100%;
  }
  .cfg-form input:focus, .cfg-form select:focus {
    outline: none; border-color: #4a9eff;
  }
  .cfg-form .toggle-row {
    display: flex; align-items: center; gap: 10px; padding-top: 2px;
  }
  .cfg-form .toggle-row label { color: #ccc; font-size: 13px; }
  .cfg-form .ch-checks {
    display: flex; gap: 10px; flex-wrap: wrap; padding-top: 2px;
  }
  .cfg-form .ch-checks label {
    display: flex; align-items: center; gap: 5px; color: #ccc; font-size: 13px;
  }
  .cfg-form .section-sep {
    grid-column: 1 / -1;
    border: none; border-top: 1px solid #2a2a2a; margin: 4px 0;
  }
  .cfg-form .section-title {
    grid-column: 1 / -1;
    font-size: 12px; font-weight: 600; color: #666; text-transform: uppercase;
    letter-spacing: .05em; margin-top: 4px;
  }
  .cfg-save-row {
    padding: 10px 16px 14px;
    display: flex; align-items: center; gap: 12px;
  }
  .cfg-save-btn {
    background: #1a3050; border: 1px solid #2a60aa; color: #6ab4ff;
    padding: 6px 20px; border-radius: 4px; font-size: 13px; cursor: pointer;
    transition: all .2s;
  }
  .cfg-save-btn:hover { background: #254070; color: #fff; }
  .cfg-save-btn:disabled { opacity: .5; cursor: not-allowed; }
  .cfg-save-msg { font-size: 12px; }
  .cfg-save-msg.ok  { color: #2ecc40; }
  .cfg-save-msg.err { color: #e74c3c; }

  /* â”€â”€ Info box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .info-box {
    margin: 14px;
    padding: 12px 16px;
    background: #1a2a3a;
    border: 1px solid #2a4a6a;
    border-radius: 6px;
    font-size: 12px;
    color: #8ab;
    line-height: 1.5;
  }
  .info-box code { background: #0a1a2a; padding: 1px 5px; border-radius: 3px; color: #acd; }
</style>
</head>
<body>

<nav>
  <h1>ğŸ“¹ DVR Dashboard</h1>
  <a href="/">Live View</a>
  <a href="/settings">Settings</a>
  <a href="/recordings" class="active">Recordings</a>
  <span class="spacer"></span>
</nav>

<!-- Control bar -->
<div class="ctrl-bar">
  <span class="label">Recording:</span>
  <span class="status-badge disabled" id="badge">â€”</span>
  <span class="spacer" style="flex:1"></span>
  <button class="ctrl-btn start" id="btn-start" onclick="startRec()" disabled>â–¶ Start</button>
  <button class="ctrl-btn stop" id="btn-stop" onclick="stopRec()" disabled>â–  Stop</button>
</div>

<div class="content">

  <!-- Channel status -->
  <div class="section">
    <div class="section-head">ğŸ“º Channel Status</div>
    <div class="ch-grid" id="ch-grid">
      <div class="ch-card"><div class="ch-detail">Loadingâ€¦</div></div>
    </div>
  </div>

  <!-- Upload status -->
  <div class="section" id="upload-section">
    <div class="section-head">â˜ï¸ Upload Status</div>
    <div class="upload-row" id="upload-row">
      <div class="item"><span class="lbl">Status:</span> <span class="val" id="upl-status">â€”</span></div>
      <div class="item"><span class="lbl">Pending:</span> <span class="val" id="upl-pending">0</span></div>
    </div>
  </div>

  <!-- Recent recordings -->
  <div class="section">
    <div class="section-head">
      ğŸ“ Recent Recordings
      <span class="spacer" style="flex:1"></span>
      <button class="ctrl-btn stop" id="btn-delete-all" onclick="deleteAll()" style="font-size:12px;padding:3px 12px">ğŸ—‘ Delete All</button>
    </div>
    <table class="rec-table">
      <thead>
        <tr><th>Channel</th><th>File</th><th>Size</th><th>Date</th><th></th></tr>
      </thead>
      <tbody id="rec-body">
        <tr><td colspan="5" class="empty-msg">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Recording Configuration (editable) -->
  <div class="section">
    <div class="section-head">âš™ï¸ Recording Configuration</div>
    <form id="cfg-form" class="cfg-form" onsubmit="saveCfg(event)">

      <!-- Basic -->
      <div class="section-title">Basic</div>

      <div class="field full">
        <div class="toggle-row">
          <input type="checkbox" id="cfg-enabled">
          <label for="cfg-enabled">Enable recording</label>
        </div>
      </div>

      <div class="field">
        <label>Channels</label>
        <div class="ch-checks" id="cfg-channels">
          <label><input type="checkbox" value="0"> CH 0</label>
          <label><input type="checkbox" value="1"> CH 1</label>
          <label><input type="checkbox" value="2"> CH 2</label>
          <label><input type="checkbox" value="3"> CH 3</label>
        </div>
      </div>

      <div class="field">
        <label>Stream quality</label>
        <select id="cfg-stream-type">
          <option value="1">Main (HD)</option>
          <option value="2">Sub (SD)</option>
        </select>
      </div>

      <div class="field">
        <label>Segment duration (minutes)</label>
        <input type="number" id="cfg-segment" min="1" max="120">
      </div>

      <div class="field">
        <label>Retention (hours, 0 = forever)</label>
        <input type="number" id="cfg-retention" min="0">
      </div>

      <div class="field">
        <label>Schedule (e.g. 0-23, 8-17, 22-6)</label>
        <input type="text" id="cfg-schedule" placeholder="0-23">
      </div>

      <div class="field full">
        <label>Storage directory</label>
        <input type="text" id="cfg-dir" placeholder="/opt/dvr/recordings">
      </div>

      <hr class="section-sep">
      <div class="section-title">Custom Upload Command</div>

      <div class="field full">
        <label>Shell command (placeholders: {file} {channel} {filename})</label>
        <input type="text" id="cfg-upload-cmd" placeholder="rclone copy {file} remote:DVR/{channel}/">
      </div>
    </form>

    <div class="cfg-save-row">
      <button class="cfg-save-btn" onclick="saveCfg()">Save &amp; Apply</button>
      <span class="cfg-save-msg" id="cfg-msg"></span>
    </div>
  </div>

  <!-- Google Drive Upload (OAuth wizard) -->
  <div class="section">
    <div class="section-head">â˜ï¸ Google Drive Upload</div>

    <!-- Connected state -->
    <div id="gdrive-connected" style="display:none">
      <div class="upload-row">
        <div class="item"><span class="lbl">Status:</span>
          <span class="val" style="color:#2ecc40">â— Connected</span></div>
        <div class="item"><span class="lbl">Folder ID:</span>
          <span class="val" id="gdrive-folder-display">â€”</span></div>
      </div>
      <div style="padding:0 14px 14px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <input type="text" id="gdrive-folder-id" placeholder="Drive folder ID"
               style="background:#111;border:1px solid #444;color:#eee;padding:5px 9px;border-radius:4px;font-size:13px;width:280px">
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:#ccc">
          <input type="checkbox" id="gdrive-delete-local"> Delete local after upload
        </label>
        <button class="ctrl-btn" style="border-color:#444" onclick="saveDriveSettings()">Save</button>
        <button class="ctrl-btn stop" onclick="driveDisconnect()">Disconnect</button>
        <span id="gdrive-save-msg" style="font-size:12px"></span>
      </div>
    </div>

    <!-- Not connected state â€” setup wizard -->
    <div id="gdrive-setup">
      <!-- Step 0: explain -->
      <div id="gdrive-step0" class="info-box" style="margin:14px">
        <strong>How to set up (one time only):</strong><br><br>
        1. Go to <a href="https://console.cloud.google.com" target="_blank" style="color:#4a9eff">console.cloud.google.com</a><br>
        2. Create a project &rarr; <em>APIs &amp; Services</em> &rarr; <strong>Enable APIs</strong> &rarr; search <strong>"Google Drive API"</strong> &rarr; Enable<br>
        3. <em>APIs &amp; Services</em> &rarr; <strong>Credentials</strong> &rarr; <em>Create Credentials</em> &rarr; <strong>OAuth 2.0 Client IDs</strong><br>
        &nbsp;&nbsp;&nbsp;Application type: <strong>TV and Limited Input devices</strong><br>
        4. Copy the <strong>Client ID</strong> and <strong>Client Secret</strong> below<br>
        5. Click <strong>Connect</strong> â€” a short code will appear, enter it on <a href="https://google.com/device" target="_blank" style="color:#4a9eff">google.com/device</a><br>
        6. Done â€” no JSON files, no pip installs.
      </div>

      <!-- Step 1: credentials -->
      <div id="gdrive-step1" style="padding:14px;display:flex;flex-direction:column;gap:12px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px 24px;font-size:13px">
          <div style="display:flex;flex-direction:column;gap:4px">
            <label style="color:#888;font-size:12px">Client ID</label>
            <input type="text" id="gdrive-client-id"
                   style="background:#111;border:1px solid #444;color:#eee;padding:5px 9px;border-radius:4px;font-size:13px">
          </div>
          <div style="display:flex;flex-direction:column;gap:4px">
            <label style="color:#888;font-size:12px">Client Secret</label>
            <input type="password" id="gdrive-client-secret"
                   style="background:#111;border:1px solid #444;color:#eee;padding:5px 9px;border-radius:4px;font-size:13px">
          </div>
          <div style="display:flex;flex-direction:column;gap:4px">
            <label style="color:#888;font-size:12px">Drive Folder ID (from folder URL)</label>
            <input type="text" id="gdrive-folder-id-setup"
                   style="background:#111;border:1px solid #444;color:#eee;padding:5px 9px;border-radius:4px;font-size:13px"
                   placeholder="1aBcDeFg...">
          </div>
          <div style="display:flex;align-items:flex-end;padding-bottom:2px">
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:#ccc">
              <input type="checkbox" id="gdrive-delete-local-setup"> Delete local after upload
            </label>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="cfg-save-btn" onclick="driveConnect()">Connect with Google</button>
          <span id="gdrive-step1-msg" style="font-size:12px;color:#e74c3c"></span>
        </div>
      </div>

      <!-- Step 2: show device code -->
      <div id="gdrive-step2" style="display:none;padding:14px">
        <div class="info-box" style="margin:0 0 14px">
          <strong>Almost there!</strong> Visit this link on any device (phone/laptop) and enter the code:
        </div>
        <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-start">
          <div style="font-size:13px;color:#888">URL:
            <a id="gdrive-verify-url" href="#" target="_blank" style="color:#4a9eff;font-size:14px"></a>
          </div>
          <div style="font-size:13px;color:#888">Code:
            <span id="gdrive-user-code"
                  style="font-size:28px;font-weight:700;letter-spacing:.2em;color:#fff;background:#1a3050;padding:6px 18px;border-radius:6px;font-family:monospace"></span>
          </div>
          <div id="gdrive-poll-msg" style="font-size:13px;color:#888">Waiting for authorizationâ€¦</div>
        </div>
      </div>
    </div>

  </div>

</div>

<script>
const API = '';  // same origin
let refreshTimer;
let _cfgLoaded = false;   // populate form only once (avoid overwriting edits)

async function fetchJSON(url) {
  const r = await fetch(API + url);
  return r.json();
}

async function refresh() {
  try {
    const [status, recs] = await Promise.all([
      fetchJSON('/api/recordings/status'),
      fetchJSON('/api/recordings'),
    ]);
    renderStatus(status);
    renderRecordings(recs);
  } catch (e) {
    console.error('Refresh error:', e);
  }
  // Load config form once (don't stomp on unsaved edits on auto-refresh)
  if (!_cfgLoaded) {
    try {
      const cfg = await fetchJSON('/api/recordings/config');
      populateCfgForm(cfg);
      _cfgLoaded = true;
    } catch (e) {
      console.error('Config load error:', e);
    }
  }
}

function renderStatus(s) {
  // Badge
  const badge = document.getElementById('badge');
  const btnStart = document.getElementById('btn-start');
  const btnStop = document.getElementById('btn-stop');

  if (!s.enabled) {
    badge.className = 'status-badge disabled';
    badge.textContent = 'Disabled';
    btnStart.disabled = true;
    btnStop.disabled = true;
  } else if (s.running) {
    badge.className = 'status-badge running';
    badge.textContent = 'Recording';
    btnStart.disabled = true;
    btnStop.disabled = false;
  } else {
    badge.className = 'status-badge stopped';
    badge.textContent = 'Stopped';
    btnStart.disabled = false;
    btnStop.disabled = true;
  }

  // Channel cards
  const grid = document.getElementById('ch-grid');
  const channels = s.channels || {};
  if (Object.keys(channels).length === 0) {
    grid.innerHTML = '<div class="ch-card"><div class="ch-detail">No channels configured</div></div>';
    return;
  }
  grid.innerHTML = '';
  for (const [ch, info] of Object.entries(channels)) {
    const state = info.state || 'unknown';
    let dotClass = 'off';
    if (state === 'recording') dotClass = 'rec';
    else if (state.startsWith('waiting')) dotClass = 'wait';
    else if (state === 'error') dotClass = 'err';

    const card = document.createElement('div');
    card.className = 'ch-card';
    card.innerHTML = `
      <div class="ch-name"><span class="dot ${dotClass}"></span> CH ${ch}</div>
      <div class="ch-detail">State: ${state}</div>
      ${info.file ? `<div class="ch-detail">File: ${info.file}</div>` : ''}
      <div class="ch-detail">Segments: ${info.segments || 0}</div>
    `;
    grid.appendChild(card);
  }

  // Upload
  const uplStatus = document.getElementById('upl-status');
  const uplPending = document.getElementById('upl-pending');
  if (s.gdrive_enabled || s.upload_command) {
    document.getElementById('upload-section').style.display = '';
    uplStatus.textContent = s.gdrive_connected ? 'â— Connected' : (s.upload_command ? 'â— Custom command' : 'â—‹ Not connected');
    uplStatus.style.color = (s.gdrive_connected || s.upload_command) ? '#2ecc40' : '#e74c3c';
    uplPending.textContent = s.upload_pending || '0';
  } else {
    document.getElementById('upload-section').style.display = 'none';
  }
}

function renderRecordings(recs) {
  const tbody = document.getElementById('rec-body');
  if (!recs || recs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty-msg">No recordings yet</td></tr>';
    return;
  }
  tbody.innerHTML = '';
  for (const r of recs) {
    const tr = document.createElement('tr');
    const date = new Date(r.modified * 1000);
    const sizeStr = formatSize(r.size);
    const uploadTag = r.uploaded ? '<span class="uploaded-tag">uploaded</span>' : '';
    tr.innerHTML = `
      <td>${r.channel}</td>
      <td>${r.filename}${uploadTag}</td>
      <td class="size">${sizeStr}</td>
      <td class="size">${date.toLocaleString()}</td>
      <td style="white-space:nowrap">
        <a href="/api/recordings/download/${r.channel}/${r.filename}" style="color:#4a9eff;text-decoration:none" title="Download">â¬‡</a>
        <button class="del-btn" title="Delete" onclick="deleteRecording('${r.channel}','${r.filename}')">ğŸ—‘</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

function populateCfgForm(c) {
  document.getElementById('cfg-enabled').checked       = !!c.enabled;
  document.getElementById('cfg-stream-type').value     = String(c.stream_type ?? 1);
  document.getElementById('cfg-segment').value         = c.segment_minutes ?? 15;
  document.getElementById('cfg-retention').value       = c.retention_hours ?? 24;
  document.getElementById('cfg-schedule').value        = c.schedule ?? '0-23';
  document.getElementById('cfg-dir').value             = c.record_dir ?? '';
  document.getElementById('cfg-upload-cmd').value      = c.upload_command ?? '';

  // Channels checkboxes
  const channels = c.channels || [];
  document.querySelectorAll('#cfg-channels input[type=checkbox]').forEach(cb => {
    cb.checked = channels.includes(parseInt(cb.value));
  });
}

async function saveCfg(evt) {
  if (evt) evt.preventDefault();
  const btn = document.querySelector('.cfg-save-btn');
  const msg = document.getElementById('cfg-msg');
  btn.disabled = true;
  msg.textContent = 'Savingâ€¦'; msg.className = 'cfg-save-msg';

  const channels = [];
  document.querySelectorAll('#cfg-channels input[type=checkbox]').forEach(cb => {
    if (cb.checked) channels.push(parseInt(cb.value));
  });

  const cfg = {
    enabled:           document.getElementById('cfg-enabled').checked,
    channels:          channels,
    stream_type:       parseInt(document.getElementById('cfg-stream-type').value),
    segment_minutes:   parseInt(document.getElementById('cfg-segment').value),
    retention_hours:   parseInt(document.getElementById('cfg-retention').value),
    schedule:          document.getElementById('cfg-schedule').value.trim(),
    record_dir:        document.getElementById('cfg-dir').value.trim(),
    upload_command:    document.getElementById('cfg-upload-cmd').value.trim(),
  };

  try {
    const r = await fetch('/api/recordings/config', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(cfg),
    });
    const data = await r.json();
    if (data.ok) {
      msg.textContent = 'âœ“ Saved & applied'; msg.className = 'cfg-save-msg ok';
      if (data.config) populateCfgForm(data.config);
      setTimeout(refresh, 800);
    } else {
      msg.textContent = 'âœ— ' + (data.error || 'Unknown error');
      msg.className = 'cfg-save-msg err';
    }
  } catch (e) {
    msg.textContent = 'âœ— ' + e; msg.className = 'cfg-save-msg err';
  }
  btn.disabled = false;
  setTimeout(() => { msg.textContent = ''; }, 4000);
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
  return (bytes / 1073741824).toFixed(2) + ' GB';
}

async function startRec() {
  try {
    await fetch('/api/recordings/start', { method: 'POST' });
    setTimeout(refresh, 1000);
  } catch (e) { alert('Failed to start: ' + e); }
}

async function stopRec() {
  try {
    await fetch('/api/recordings/stop', { method: 'POST' });
    setTimeout(refresh, 1000);
  } catch (e) { alert('Failed to stop: ' + e); }
}

async function deleteRecording(channel, filename) {
  if (!confirm(`Delete ${channel}/${filename}?`)) return;
  try {
    const r = await fetch(`/api/recordings/${channel}/${filename}`, { method: 'DELETE' });
    const d = await r.json();
    if (d.ok) {
      refresh();
    } else {
      alert('Delete failed: ' + (d.error || 'Unknown error'));
    }
  } catch (e) { alert('Delete failed: ' + e); }
}

async function deleteAll() {
  const tbody = document.getElementById('rec-body');
  const count = tbody.querySelectorAll('tr:not(.empty-msg)').length;
  if (count === 0) { alert('No recordings to delete.'); return; }
  if (!confirm(`Delete all ${count} recording(s)? This cannot be undone.`)) return;
  const btn = document.getElementById('btn-delete-all');
  btn.disabled = true;
  try {
    const r = await fetch('/api/recordings/delete-all', { method: 'POST' });
    const d = await r.json();
    if (d.ok) {
      refresh();
    } else {
      alert('Delete failed: ' + (d.error || 'Unknown error'));
    }
  } catch (e) { alert('Delete failed: ' + e); }
  btn.disabled = false;
}

// â”€â”€ Google Drive OAuth wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _drivePollingTimer = null;
let _drivePollDeviceCode = '';
let _drivePollInterval   = 5;

async function loadGdriveStatus() {
  try {
    const s = await fetchJSON('/api/gdrive/status');
    const isConnected = s.connected;
    document.getElementById('gdrive-connected').style.display = isConnected ? '' : 'none';
    document.getElementById('gdrive-setup').style.display     = isConnected ? 'none' : '';
    if (isConnected) {
      document.getElementById('gdrive-folder-display').textContent = s.folder_id || '(none)';
      document.getElementById('gdrive-folder-id').value            = s.folder_id || '';
    } else {
      if (s.client_id) document.getElementById('gdrive-client-id').value = s.client_id;
      if (s.folder_id) document.getElementById('gdrive-folder-id-setup').value = s.folder_id;
    }
  } catch(e) { console.error('gdrive status:', e); }
}

async function saveDriveSettings() {
  const msg = document.getElementById('gdrive-save-msg');
  const folder_id    = document.getElementById('gdrive-folder-id').value.trim();
  const delete_local = document.getElementById('gdrive-delete-local').checked;
  try {
    const r = await fetch('/api/gdrive/config', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ folder_id, delete_local }),
    });
    const d = await r.json();
    if (d.ok) { msg.textContent='âœ“ Saved'; msg.style.color='#2ecc40'; }
    else      { msg.textContent='âœ— ' + (d.error||'Error'); msg.style.color='#e74c3c'; }
  } catch(e) { msg.textContent='âœ— '+e; msg.style.color='#e74c3c'; }
  setTimeout(()=>{ msg.textContent=''; }, 3000);
}

async function driveConnect() {
  const clientId     = document.getElementById('gdrive-client-id').value.trim();
  const clientSecret = document.getElementById('gdrive-client-secret').value.trim();
  const folderId     = document.getElementById('gdrive-folder-id-setup').value.trim();
  const deleteLocal  = document.getElementById('gdrive-delete-local-setup').checked;
  const errEl        = document.getElementById('gdrive-step1-msg');

  if (!clientId || !clientSecret) {
    errEl.textContent = 'Client ID and Secret are required'; return;
  }
  errEl.textContent = 'Saving credentialsâ€¦';

  try {
    // Save credentials first
    await fetch('/api/gdrive/config', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ client_id: clientId, client_secret: clientSecret,
                             folder_id: folderId, delete_local: deleteLocal }),
    });
    // Start device flow
    const r = await fetch('/api/gdrive/connect', { method: 'POST' });
    const d = await r.json();
    if (d.error) { errEl.textContent = 'âœ— ' + d.error; return; }

    // Show step 2 code
    document.getElementById('gdrive-step1').style.display = 'none';
    document.getElementById('gdrive-step2').style.display = '';
    document.getElementById('gdrive-step0').style.display = 'none';
    const urlEl  = document.getElementById('gdrive-verify-url');
    urlEl.href        = d.verification_url;
    urlEl.textContent = d.verification_url;
    document.getElementById('gdrive-user-code').textContent = d.user_code;
    document.getElementById('gdrive-poll-msg').textContent  = 'Waiting for authorizationâ€¦';

    _drivePollDeviceCode = d.device_code;
    _drivePollInterval   = (d.interval || 5) * 1000;
    if (_drivePollingTimer) clearInterval(_drivePollingTimer);
    _drivePollingTimer = setInterval(_pollDrive, _drivePollInterval);
  } catch(e) {
    errEl.textContent = 'âœ— ' + e;
  }
}

async function _pollDrive() {
  try {
    const r = await fetch('/api/gdrive/poll?device_code=' + encodeURIComponent(_drivePollDeviceCode));
    const d = await r.json();
    if (d.status === 'connected') {
      clearInterval(_drivePollingTimer); _drivePollingTimer = null;
      document.getElementById('gdrive-poll-msg').textContent = 'âœ“ Connected!';
      document.getElementById('gdrive-poll-msg').style.color = '#2ecc40';
      setTimeout(loadGdriveStatus, 1200);
    } else if (d.status === 'error') {
      clearInterval(_drivePollingTimer); _drivePollingTimer = null;
      document.getElementById('gdrive-poll-msg').textContent = 'âœ— ' + d.error;
      document.getElementById('gdrive-poll-msg').style.color = '#e74c3c';
    }
    // pending â†’ keep polling
  } catch(e) { /* ignore transient network errors */ }
}

async function driveDisconnect() {
  if (!confirm('Disconnect Google Drive?')) return;
  try {
    await fetch('/api/gdrive/disconnect', { method: 'POST' });
    if (_drivePollingTimer) { clearInterval(_drivePollingTimer); _drivePollingTimer = null; }
    loadGdriveStatus();
  } catch(e) { alert('Disconnect failed: ' + e); }
}

// Initial load + auto-refresh every 10s
refresh();
loadGdriveStatus();
refreshTimer = setInterval(refresh, 10000);
</script>
</body>
</html>
