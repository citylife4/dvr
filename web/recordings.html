<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DVR â€” Recordings</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #111;
    color: #ccc;
    font-family: system-ui, -apple-system, sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  nav {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 8px 16px;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
    flex-shrink: 0;
  }
  nav h1 { font-size: 16px; font-weight: 600; color: #eee; }
  nav a {
    color: #888;
    text-decoration: none;
    font-size: 14px;
    padding: 4px 12px;
    border-radius: 4px;
    transition: all 0.2s;
  }
  nav a:hover { color: #ccc; background: #2a2a2a; }
  nav a.active { color: #fff; background: #2a6a2a; }
  nav .spacer { flex: 1; }

  /* â”€â”€ Hero Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .hero-status {
    background: #161616;
    border-bottom: 1px solid #282828;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
  }
  .status-indicator {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .status-dot {
    width: 12px; height: 12px; border-radius: 50%;
    background: #444;
    transition: all 0.3s;
  }
  .status-text {
    font-size: 15px; font-weight: 600; color: #aaa;
  }
  .status-sub {
    font-size: 12px; color: #666; margin-left: 0;
  }
  
  /* Status states */
  .hero-status.active .status-dot { background: #2ecc40; box-shadow: 0 0 10px rgba(46,204,64,0.4); }
  .hero-status.active .status-text { color: #eee; }
  
  .hero-btn {
    border: none;
    padding: 10px 24px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .hero-btn.start {
    background: #1a5a1a; color: #fff; border: 1px solid #2a7a2a;
  }
  .hero-btn.start:hover { background: #2a7a2a; transform: translateY(-1px); }
  
  .hero-btn.stop {
    background: #5a1a1a; color: #faaaaa; border: 1px solid #7a2a2a;
  }
  .hero-btn.stop:hover { background: #7a2a2a; color: #fff; transform: translateY(-1px); }
  
  .hero-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* â”€â”€ Disk Usage Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .disk-bar-wrap {
    flex: 1;
    min-width: 180px;
    max-width: 320px;
  }
  .disk-label {
    font-size: 11px; color: #888; margin-bottom: 4px;
    display: flex; justify-content: space-between;
  }
  .disk-bar {
    height: 8px; background: #222; border-radius: 4px; overflow: hidden;
    border: 1px solid #333;
  }
  .disk-bar-fill {
    height: 100%; border-radius: 4px; transition: width 0.5s, background 0.3s;
    background: #2ecc40;
  }
  .disk-bar-fill.warn { background: #f39c12; }
  .disk-bar-fill.crit { background: #e74c3c; }

  /* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main-grid {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 20px;
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
    align-items: start;
  }
  @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
  
  .panel {
    background: #1a1a1a;
    border: 1px solid #282828;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .panel-head {
    padding: 12px 16px;
    background: #1f1f1f;
    border-bottom: 1px solid #282828;
    font-size: 13px;
    font-weight: 700;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .panel-body {
    padding: 16px;
  }

  /* â”€â”€ Config Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cfg-field { margin-bottom: 16px; }
  .cfg-field label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; font-weight: 500; }
  
  input[type="text"], input[type="password"], input[type="number"], select {
    background: #0a0a0a; border: 1px solid #444; color: #eee;
    padding: 8px 10px; border-radius: 4px; font-size: 13px; width: 100%;
    transition: border-color 0.2s;
  }
  input:focus, select:focus { outline: none; border-color: #4a9eff; }
  
  .ch-checks { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .ch-check-item {
    background: #222; padding: 6px 10px; border-radius: 4px;
    display: flex; align-items: center; gap: 8px; font-size: 13px;
    cursor: pointer; border: 1px solid #333; select: none;
  }
  .ch-check-item:hover { border-color: #555; }
  .ch-check-item input { margin: 0; }

  .save-btn {
    width: 100%;
    background: #1a3050; border: 1px solid #2a5080; color: #8abfff;
    padding: 10px; border-radius: 4px; font-weight: 600; cursor: pointer;
    font-size: 13px; transition: all 0.2s;
  }
  .save-btn:hover { background: #254070; color: #fff; }
  
  /* â”€â”€ Cloud Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cloud-box {
    background: #141414; border: 1px solid #333; border-radius: 6px; padding: 12px;
  }
  .cloud-status-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
  .cloud-label { display: flex; align-items: center; gap: 6px; font-weight: 600; color: #ccc; }
  .cloud-val { font-size: 12px; font-weight: 600; }
  .cloud-val.on { color: #2ecc40; }
  .cloud-val.off { color: #666; }
  
  .cloud-setup-btn {
    background: none; border: none; color: #4a9eff; font-size: 12px; cursor: pointer; text-decoration: underline; padding: 0;
  }
  .cloud-wizard {
    margin-top: 12px; padding-top: 12px; border-top: 1px solid #333;
    display: none;
  }
  .cloud-wizard.open { display: block; }
  .wizard-step { font-size: 12px; color: #888; margin-bottom: 8px; font-weight: 600; }
  
  /* â”€â”€ Recordings Browser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .date-ctrl {
    display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
  }
  .date-display {
    font-size: 14px; font-weight: 600; color: #eee;
    background: #222; padding: 6px 12px; border-radius: 4px; border: 1px solid #333;
    flex: 1; text-align: center; cursor: pointer;
  }
  .nav-arr {
    background: #222; border: 1px solid #333; color: #ccc; width: 32px; height: 32px;
    border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .nav-arr:hover { background: #333; }
  .nav-arr:disabled { opacity: 0.3; cursor: default; }

  .rec-list {
    display: flex; flex-direction: column; gap: 2px;
    max-height: 600px; overflow-y: auto;
  }
  .rec-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 12px; background: #161616; border-radius: 4px; border: 1px solid #222;
    transition: background 0.1s;
  }
  .rec-item:hover { background: #1c1c1c; border-color: #333; }
  .rec-info { display: flex; flex-direction: column; gap: 4px; }
  .rec-time { font-size: 14px; font-weight: 600; color: #ddd; display: flex; align-items: center; gap: 8px; }
  .rec-ch-badge { 
    background: #333; color: #aaa; font-size: 10px; padding: 2px 4px; border-radius: 3px; font-weight: normal; 
  }
  .rec-meta { font-size: 11px; color: #666; display: flex; gap: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }
  .rec-actions { display: flex; gap: 12px; align-items: center; }
  .action-icon {
    color: #666; cursor: pointer; font-size: 16px; text-decoration: none; padding: 4px;
    transition: color 0.2s; border: none; background: none;
  }
  .action-icon.dl:hover { color: #4a9eff; }
  .action-icon.del:hover { color: #e74c3c; }
  
  .hour-header {
    font-size: 11px; font-weight: 700; color: #555; margin: 12px 0 6px 4px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  
  .empty-state { text-align: center; padding: 40px; color: #444; font-style: italic; font-size: 14px; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: #111; }
  ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #555; }

</style>
</head>
<body>

<nav>
  <h1>ğŸ“¹ DVR Dashboard</h1>
  <a href="/">Live View</a>
  <a href="/settings">Settings</a>
  <a href="/recordings" class="active">Recordings</a>
  <span class="spacer"></span>
</nav>

<!-- Hero Status -->
<div class="hero-status" id="hero-status">
  <div class="status-indicator">
    <div class="status-dot" id="main-dot"></div>
    <div>
      <div class="status-text" id="main-status">Checking Status...</div>
      <div class="status-sub" id="main-sub">Connecting to service...</div>
    </div>
  </div>
  <div class="disk-bar-wrap" id="disk-wrap" style="display:none">
    <div class="disk-label">
      <span id="disk-label-left">Disk</span>
      <span id="disk-label-right">â€”</span>
    </div>
    <div class="disk-bar"><div class="disk-bar-fill" id="disk-fill" style="width:0%"></div></div>
  </div>
  <button class="hero-btn start" id="main-btn" onclick="toggleService()" disabled>
    Please Wait...
  </button>
</div>

<div class="main-grid">

  <!-- LEFT: Configuration -->
  <div class="panel">
    <div class="panel-head">Recording Settings</div>
    <div class="panel-body">
      
      <!-- Channels -->
      <div class="cfg-field">
        <label>Active Channels</label>
        <div class="ch-checks" id="cfg-channels">
          <label class="ch-check-item"><input type="checkbox" value="0"> Channel 0</label>
          <label class="ch-check-item"><input type="checkbox" value="1"> Channel 1</label>
          <label class="ch-check-item"><input type="checkbox" value="2"> Channel 2</label>
          <label class="ch-check-item"><input type="checkbox" value="3"> Channel 3</label>
        </div>
      </div>

      <!-- Quality -->
      <div class="cfg-field">
        <label>Stream Quality</label>
        <select id="cfg-stream-type">
          <option value="1">Main Stream (1080p, HD)</option>
          <option value="2">Sub Stream (CIF, SD)</option>
        </select>
      </div>
      
      <!-- Retention -->
      <div class="cfg-field">
        <label>Retention (Hours)</label>
        <input type="number" id="cfg-retention" min="0" placeholder="e.g. 24 (0 = forever)">
      </div>

      <!-- Recording Directory -->
      <div class="cfg-field">
        <label>Recording Directory</label>
        <input type="text" id="cfg-record-dir" placeholder="/mnt/usb/recordings">
      </div>

      <!-- Min Disk Space -->
      <div class="cfg-field">
        <label>Min Free Disk (MB)</label>
        <input type="number" id="cfg-min-disk" min="50" step="50" placeholder="e.g. 500">
      </div>

      <!-- Cloud Backup -->
      <div class="cfg-field">
        <label>Cloud Backup (Google Drive)</label>
        <div class="cloud-box">
          <div class="cloud-status-row">
            <span class="cloud-label">
              <span id="cld-icon">â˜ï¸</span> <span id="cld-text">Google Drive</span>
            </span>
            <span class="cloud-val off" id="cld-status">Not Configured</span>
          </div>
          <div style="margin-top:8px; display:flex; justify-content:flex-end">
            <button class="cloud-setup-btn" id="cld-action" onclick="toggleCloudWizard()">Setup Cloud Backup</button>
          </div>
          
          <!-- Wizard -->
          <div class="cloud-wizard" id="cloud-wizard">
            
            <!-- Step 1: Credentials -->
            <div id="wiz-step1">
              <div class="wizard-step">1. Enter API Credentials</div>
              <input type="text" id="g-client-id" placeholder="OAuth Client ID" style="margin-bottom:8px">
              <input type="password" id="g-client-secret" placeholder="OAuth Client Secret" style="margin-bottom:8px">
              <input type="text" id="g-folder-id" placeholder="Folder ID (optional)">
              <div style="margin-top:8px; display:flex; gap:6px; align-items:center;">
                <input type="checkbox" id="g-delete-local" style="width:auto"> <span style="font-size:12px;color:#888">Delete local file after upload</span>
              </div>
              <button class="save-btn" onclick="connectGoogle()" style="margin-top:12px">Connect Account</button>
              <div style="margin-top:8px; font-size:11px; color:#666; line-height:1.4">
                Note: You need a project in Google Cloud Console with the Drive API enabled and an "OAuth 2.0 Client ID" for Desktop/TV.
              </div>
            </div>

            <!-- Step 2: Auth Link -->
            <div id="wiz-step2" style="display:none">
              <div class="wizard-step">2. Authorize this device</div>
              <div style="background:#222; padding:12px; border-radius:4px; text-align:center; margin-bottom:12px">
                <a id="auth-url" href="#" target="_blank" style="color:#4a9eff; font-size:13px; word-break:break-all; display:block; margin-bottom:8px">Click here to authorize</a>
                <div style="font-size:11px; color:#aaa; margin-bottom:4px">Then enter this code if asked:</div>
                <div id="auth-code" style="font-size:24px; font-weight:700; color:#fff; letter-spacing:2px; font-family:monospace">CODE</div>
              </div>
              <div style="text-align:center; font-size:12px; color:#aaa" id="auth-msg">Waiting for authorization...</div>
            </div>

          </div>
        </div>
      </div>

      <button class="save-btn" id="btn-save" onclick="saveConfig()">Save Settings</button>
      <div id="save-msg" style="text-align:center; font-size:12px; margin-top:8px; height:16px;"></div>

    </div>
  </div>

  <!-- RIGHT: Browser -->
  <div class="panel">
    <div class="panel-head">
      <span>Recordings Browser</span>
      <button onclick="loadRecordings(true)" title="Refresh List" style="background:none;border:none;color:#666;cursor:pointer;font-size:16px;padding:0 4px">â†»</button>
    </div>
    <div class="panel-body">
      
      <div class="date-ctrl">
        <button class="nav-arr" id="d-prev" onclick="navDate(1)">â€¹</button>
        <select class="date-display" id="date-select" onchange="changeDate(this.value)">
           <option value="">Loading Dates...</option>
        </select>
        <button class="nav-arr" id="d-next" onclick="navDate(-1)">â€º</button>
      </div>

      <div class="rec-list" id="rec-list">
        <div class="empty-state">Select a date to view recordings</div>
      </div>
      
      <button class="save-btn" id="load-more" onclick="loadMore()" style="margin-top:12px; background:#222; border-color:#333; color:#aaa; display:none">
        Load More...
      </button>

    </div>
  </div>

</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = '/api';
let _config = {};
let _status = {};
let _dates = [];
let _currentDate = null;
let _recs = [];
let _offset = 0;
let _pollTimer = null;

// â”€â”€ Initialization â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', async () => {
  await loadStatus();
  await loadConfig();
  await loadDates();
  
  // Auto-select latest date if available
  if (_dates.length > 0) {
    changeDate(_dates[0]);
  } else {
    document.getElementById('rec-list').innerHTML = '<div class="empty-state">No recording dates found.</div>';
    document.getElementById('date-select').innerHTML = '<option>No Dates</option>';
  }

  // Poll status every 3s
  setInterval(loadStatus, 3000);
});

// â”€â”€ Unified Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function toggleService() {
  const btn = document.getElementById('main-btn');
  const isRunning = _status.running;
  
  btn.disabled = true;
  const originalText = btn.innerHTML;
  btn.innerHTML = isRunning ? "Stopping..." : "Starting...";
  
  try {
    if (!isRunning) {
      // STARTING:
      // 1. Save config first (enabled=true)
      await saveConfig(true, true); 
      // 2. Call start endpoint
      const res = await fetch(API + '/recordings/start', { method: 'POST' });
      if (!res.ok) throw new Error("Start failed");
    } else {
      // STOPPING:
      // 1. Save config first (enabled=false) to persist state
      await saveConfig(true, false);
      // 2. Call stop endpoint
      const res = await fetch(API + '/recordings/stop', { method: 'POST' });
      if (!res.ok) throw new Error("Stop failed");
    }
  } catch(e) {
    alert("Action failed: " + e.message);
    btn.innerHTML = originalText;
  } finally {
    // Refresh status immediately, then let poller take over
    await loadStatus();
    // Button state will be updated by loadStatus
  }
}

async function saveConfig(silent = false, forceEnabled = null) {
  const btn = document.getElementById('btn-save');
  const msg = document.getElementById('save-msg');
  
  if (!silent) {
    btn.disabled = true;
    msg.textContent = "Saving...";
    msg.style.color = "#888"; // Reset color
  }

  // Collect active channels
  const channels = [];
  document.querySelectorAll('#cfg-channels input:checked').forEach(cb => channels.push(parseInt(cb.value)));

  // Determine enabled state:
  // - If forceEnabled is boolean, use it.
  // - Otherwise, default to true if saving from UI (user likely wants it enabled if configuring it)
  // - OR better: if silent=false (UI save), assume enabled=true.
  const isEnabled = (forceEnabled !== null) ? forceEnabled : true;

  const cfg = {
    enabled: isEnabled, 
    channels: channels,
    stream_type: parseInt(document.getElementById('cfg-stream-type').value),
    retention_hours: parseInt(document.getElementById('cfg-retention').value) || 0,
    record_dir: document.getElementById('cfg-record-dir').value.trim() || _config.record_dir || '',
    min_disk_mb: parseInt(document.getElementById('cfg-min-disk').value) || 500,
    // Preserve hidden fields if possible, or defaults
    segment_minutes: _config.segment_minutes || 15, 
    schedule: _config.schedule || "0-23",
  };

  try {
    const res = await fetch(API + '/recordings/config', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(cfg)
    });
    
    if (!res.ok) throw new Error("Save failed");
    
    if (!silent) {
      msg.textContent = "âœ“ Settings Saved";
      msg.style.color = "#2ecc40";
    }
    // Update local cache
    _config = cfg;
    
  } catch(e) {
    console.error(e);
    if (!silent) {
      msg.textContent = "âœ— Error Saving";
      msg.style.color = "#e74c3c";
    }
  } finally {
    if (!silent) {
      btn.disabled = false;
      setTimeout(() => msg.textContent = "", 3000);
    }
  }
}

// â”€â”€ Status Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadStatus() {
  try {
    const r = await fetch(API + '/recordings/status');
    if (!r.ok) return;
    _status = await r.json();
    renderStatus();
    
    if (_status.gdrive_connected !== undefined) {
      renderCloudStatus(_status);
    }
  } catch(e) { console.warn("Status poll failed", e); }
}

function renderStatus() {
  const hero = document.getElementById('hero-status');
  const btn = document.getElementById('main-btn');
  const txt = document.getElementById('main-status');
  const sub = document.getElementById('main-sub');

  // Render disk usage bar
  renderDisk(_status.disk);

  // Interpret 'running' as the service is active
  if (_status.running) {
    hero.classList.add('active');
    
    const count = Object.values(_status.channels || {}).filter(c => c.state === 'recording').length;
    const total = Object.keys(_status.channels || {}).length;
    
    // Check for disk-paused channels
    const paused = Object.values(_status.channels || {}).filter(c => (c.state || '').includes('disk')).length;
    
    txt.textContent = "Status: Active (Recording)";
    if (paused > 0) {
      sub.textContent = `${count} recording, ${paused} paused (disk low)`;
    } else {
      sub.textContent = `${count} of ${total} configured channels recording`;
    }
    
    btn.className = "hero-btn stop";
    btn.innerHTML = "â–  Stop Recording Service";
    btn.disabled = false;
  } else {
    hero.classList.remove('active');
    txt.textContent = "Status: Inactive";
    sub.textContent = "Service is stopped";
    
    btn.className = "hero-btn start";
    btn.innerHTML = "â–¶ Start Recording Service";
    btn.disabled = false;
  }
}

function renderDisk(disk) {
  const wrap = document.getElementById('disk-wrap');
  if (!disk || !disk.total_mb) { wrap.style.display = 'none'; return; }
  wrap.style.display = '';
  const pct = disk.used_pct || 0;
  const fill = document.getElementById('disk-fill');
  fill.style.width = pct + '%';
  fill.className = 'disk-bar-fill' + (pct >= 90 ? ' crit' : pct >= 75 ? ' warn' : '');
  const freeTxt = disk.free_mb >= 1024 ? (disk.free_mb / 1024).toFixed(1) + ' GB' : disk.free_mb + ' MB';
  const totalTxt = disk.total_mb >= 1024 ? (disk.total_mb / 1024).toFixed(1) + ' GB' : disk.total_mb + ' MB';
  document.getElementById('disk-label-left').textContent = disk.path || 'Disk';
  document.getElementById('disk-label-right').textContent = freeTxt + ' free / ' + totalTxt;
  if (!disk.ok) {
    document.getElementById('disk-label-right').style.color = '#e74c3c';
  } else {
    document.getElementById('disk-label-right').style.color = '';
  }
}

function renderCloudStatus(s) {
  const val = document.getElementById('cld-status');
  const act = document.getElementById('cld-action');
  const wiz = document.getElementById('cloud-wizard');

  if (s.gdrive_connected) {
    val.textContent = "Connected (Online)";
    val.className = "cloud-val on";
    act.textContent = "Disconnect Account";
    act.onclick = disconnectCloud;
    wiz.style.display = 'none'; // Auto-close wizard on connect
  } else {
    val.textContent = "Not Configured";
    val.className = "cloud-val off";
    act.textContent = "Setup Cloud Backup";
    act.onclick = toggleCloudWizard;
  }
}

// â”€â”€ Config Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadConfig() {
  try {
    const r = await fetch(API + '/recordings/config');
    if (!r.ok) return;
    const c = await r.json();
    _config = c;
    
    const stVal = c.stream_type !== undefined ? c.stream_type : 1;
    document.getElementById('cfg-stream-type').value = stVal;
    
    const retVal = c.retention_hours !== undefined ? c.retention_hours : 24;
    document.getElementById('cfg-retention').value = retVal;
    
    document.getElementById('cfg-record-dir').value = c.record_dir || '';
    document.getElementById('cfg-min-disk').value = c.min_disk_mb !== undefined ? c.min_disk_mb : 500;
    
    // Checkboxes
    const chs = c.channels || [];
    document.querySelectorAll('#cfg-channels input').forEach(cb => {
      cb.checked = chs.includes(parseInt(cb.value));
    });
    
  } catch(e) { console.error("Config load failed", e); }
}

// â”€â”€ Google Drive Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function toggleCloudWizard() {
  const wiz = document.getElementById('cloud-wizard');
  if (wiz.style.display === 'block') {
    wiz.style.display = 'none';
  } else {
    wiz.style.display = 'block';
    // Reset view
    document.getElementById('wiz-step1').style.display = 'block';
    document.getElementById('wiz-step2').style.display = 'none';
  }
}

async function connectGoogle() {
  const clientId = document.getElementById('g-client-id').value.trim();
  const clientSecret = document.getElementById('g-client-secret').value.trim();
  const folderId = document.getElementById('g-folder-id').value.trim();
  const delLocal = document.getElementById('g-delete-local').checked;

  if (!clientId || !clientSecret) {
    alert("Client ID and Secret are required.");
    return;
  }

  // Show loading state
  const btn = document.querySelector('#wiz-step1 .save-btn');
  const oldText = btn.textContent;
  btn.textContent = "Connecting...";
  btn.disabled = true;

  try {
    // 1. Save config first
    await fetch(API + '/gdrive/config', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        client_id: clientId, client_secret: clientSecret, 
        folder_id: folderId, delete_local: delLocal
      })
    });

    // 2. Start flow
    const r = await fetch(API + '/gdrive/connect', { method: 'POST' });
    const d = await r.json();
    
    if (d.error) throw new Error(d.error);

    // Show Step 2
    document.getElementById('wiz-step1').style.display = 'none';
    document.getElementById('wiz-step2').style.display = 'block';
    
    document.getElementById('auth-url').href = d.verification_url;
    // document.getElementById('auth-url').textContent = d.verification_url; // Link is cleaner
    document.getElementById('auth-code').textContent = d.user_code;

    // 3. Poll
    pollDriveAuth(d.device_code, d.interval || 5);
    
  } catch(e) {
    alert("Connection init failed: " + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = oldText;
  }
}

function pollDriveAuth(deviceCode, interval) {
  if (_pollTimer) clearInterval(_pollTimer);
  
  _pollTimer = setInterval(async () => {
    try {
      const r = await fetch(API + '/gdrive/poll?device_code=' + encodeURIComponent(deviceCode));
      const d = await r.json();
      
      if (d.status === 'connected') {
        clearInterval(_pollTimer);
        alert("Google Drive Connected Successfully!");
        // Refresh status to update UI
        loadStatus();
      } else if (d.status === 'error') {
        clearInterval(_pollTimer);
        document.getElementById('auth-msg').textContent = "Error: " + d.error;
        document.getElementById('auth-msg').style.color = "#e74c3c";
      }
    } catch(e) {}
  }, interval * 1000);
}

async function disconnectCloud() {
  if (!confirm("Are you sure you want to disconnect Google Drive?\nUploads will stop immediately.")) return;
  try {
    await fetch(API + '/gdrive/disconnect', { method: 'POST' });
    loadStatus();
  } catch(e) { alert("Error: " + e); }
}

// â”€â”€ Recordings Browser Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadDates() {
  try {
    const r = await fetch(API + '/recordings/dates');
    if (!r.ok) return;
    _dates = await r.json() || [];
    
    const sel = document.getElementById('date-select');
    sel.innerHTML = '';
    
    if (!_dates || _dates.length === 0) {
      sel.add(new Option('No Dates Found', ''));
      sel.disabled = true;
      return;
    }
    
    sel.disabled = false;
    // Dates are usually YYYY-MM-DD strings. Sort descending just in case.
    _dates.sort().reverse();
    
    _dates.forEach(d => sel.add(new Option(d, d)));
  } catch(e) { console.error("Dates load failed", e); }
}

function changeDate(date) {
  if (!date) return;
  _currentDate = date;
  document.getElementById('date-select').value = date;
  loadRecordings(true); // reset list
  updateNav();
}

function navDate(dir) {
  if (!_dates || _dates.length === 0) return;
  const idx = _dates.indexOf(_currentDate);
  if (idx === -1) return;
  // dir: 1 (prev day, older, higher index in desc list)
  // dir: -1 (next day, newer, lower index in desc list)
  const newIdx = idx + dir; 
  
  if (newIdx >= 0 && newIdx < _dates.length) {
    changeDate(_dates[newIdx]);
  }
}

function updateNav() {
  const idx = _dates.indexOf(_currentDate);
  // 0 is newest
  // length-1 is oldest
  document.getElementById('d-next').disabled = (idx <= 0);
  document.getElementById('d-prev').disabled = (idx >= _dates.length - 1);
}

async function loadRecordings(reset = false) {
  if (reset) {
    _offset = 0;
    _recs = [];
    document.getElementById('rec-list').innerHTML = '<div class="empty-state">Loading recordings...</div>';
    document.getElementById('load-more').style.display = 'none';
  }
  
  try {
    const r = await fetch(API + `/recordings?date=${_currentDate}&offset=${_offset}&limit=50`);
    if (!r.ok) throw new Error("Fetch failed");
    const newItems = await r.json();
    
    if (reset) _recs = newItems;
    else _recs = _recs.concat(newItems);
    
    _offset += newItems.length;
    renderList();
    
    const moreBtn = document.getElementById('load-more');
    if (newItems.length < 50) moreBtn.style.display = 'none';
    else moreBtn.style.display = 'block';
    
  } catch(e) {
     document.getElementById('rec-list').innerHTML = '<div class="empty-state">Unable to load recordings.</div>';
  }
}

function renderList() {
  const list = document.getElementById('rec-list');
  if (_recs.length === 0) {
    list.innerHTML = '<div class="empty-state">No recordings found for this date.</div>';
    return;
  }
  
  list.innerHTML = '';
  
  // Group by hour
  let lastHour = -1;
  
  _recs.forEach(r => {
    const d = new Date(r.modified * 1000);
    const h = d.getHours();
    
    if (h !== lastHour) {
      const hdr = document.createElement('div');
      hdr.className = 'hour-header';
      // Format hour like "14:00"
      hdr.textContent = `${String(h).padStart(2,'0')}:00`;
      list.appendChild(hdr);
      lastHour = h;
    }
    
    const div = document.createElement('div');
    div.className = 'rec-item';
    
    const timeStr = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    const sizeMB = (r.size / 1048576).toFixed(1);
    const badge = `<span class="rec-ch-badge">CH${r.channel}</span>`;
    const cloudIcon = r.uploaded ? '<span title="Uploaded to Drive" style="color:#2ecc40;cursor:help">â˜</span>' : '';
    
    div.innerHTML = `
      <div class="rec-info">
        <div class="rec-time">
          ${timeStr} ${badge} ${cloudIcon}
        </div>
        <div class="rec-meta" title="${r.filename}">
          ${sizeMB} MB â€¢ ${r.filename}
        </div>
      </div>
      <div class="rec-actions">
        <a href="/api/recordings/download/${r.channel}/${r.filename}" class="action-icon dl" title="Download">â¬‡</a>
        <button onclick="deleteRec('${r.channel}','${r.filename}')" class="action-icon del" title="Delete">ğŸ—‘</button>
      </div>
    `;
    list.appendChild(div);
  });
}

async function deleteRec(ch, fname) {
  if (!confirm("Delete this recording permanently?")) return;
  try {
    const res = await fetch(API + `/recordings/${ch}/${fname}`, { method: 'DELETE' });
    if (res.ok) {
      _recs = _recs.filter(r => !(r.channel == ch && r.filename == fname));
      renderList();
    } else {
      alert("Delete failed.");
    }
  } catch(e) { alert("Error deleting: " + e); }
}

</script>
</body>
</html>
